var screenshot={init:function(){},captureVisible:function(e){$.extend(screenshot,{callback:null,runCallback:!1,keepIt:!1,scroll:!1,cropData:null,retries:0,showScrollBar:!0,disableHeaderAndFooter:!1,processFixedElements:!1},e),localStorage.captureWithoutScroll++,screenshot.load(screenshot.addScreen)},captureAll:function(e){$.extend(screenshot,{callback:null,runCallback:!1,keepIt:!1,scroll:!0,cropData:null,retries:0,showScrollBar:!1,disableHeaderAndFooter:!1,processFixedElements:!0},e),localStorage.captureWithScroll++,screenshot.load(screenshot.addScreen)},captureDesktop:function(){chrome.tabs.create({url:chrome.extension.getURL("/editor.html#capture")})},captureRegion:function(){screenshot.tryGetUrl(function(){chrome.tabs.executeScript(screenshot.thisTabId,{code:"load_cropper_without_selection()"},function(){chrome.runtime.lastError&&(console.log(chrome.runtime.lastError),alert(chrome.runtime.lastError.message))})})},editContent:function(){screenshot.tryGetUrl(function(){chrome.tabs.executeScript(screenshot.thisTabId,{allFrames:!0,code:'document.designMode="on"'},function(){alert("Now you can edit this page")})})},callback:null,runCallback:!1,keepIt:!1,scroll:!1,cropData:null,retries:0,showScrollBar:!1,disableHeaderAndFooter:!1,processFixedElements:!1,executeOnPermission_array:[],webcam:null,apppick:null,screenShotParams:null,screens:[],lastImg:"",thisTab:null,thisTabId:"",thisTabTitle:"",url:"",title:"",canvas:"",canvasToDataURL:"",tryGetUrl:function(e){screenshot.description="",chrome.tabs.query({active:!0,currentWindow:!0},function(t){t.length?(t=t[0],screenshot.thisTab=t,screenshot.thisTabId=t.id,screenshot.thisTabTitle=t.title,screenshot.url=t.url,screenshot.title=t.title,screenshot.thisWindowId=t.windowId,e(screenshot.url)):alert("Can not run on this tab.")})},load:function(e){screenshot.tryGetUrl(function(){var t=e;screenshot.screens=[],screenshot.description="",api.callPopup({type:"working"}),e=function(){window.setTimeout(t,1e3*(parseInt(localStorage.delay,10)||0))},localStorage.captureCount||(localStorage.captureCount=0),e()})},webcamfn:function(){chrome.tabs.create({url:"videocap.html"})},mhtml:function(){chrome.permissions.request({permissions:["pageCapture"]},function(){chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.pageCapture.saveAsMHTML({tabId:e.id},function(e){screenshot.tryGetUrl(function(t){t=screenshot.title,t+="-"+(new Date).getHours().toString().twoDigits()+(new Date).getMinutes().toString().twoDigits()+(new Date).getSeconds().toString().twoDigits(),t+=".mhtml",chrome.tabs.create({url:"saved.html#"+url});var s=document.createEvent("MouseEvents");s.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!0,!1,!1,0,null),$("a").attr({href:url=URL.createObjectURL(e),download:t})[0].dispatchEvent(s)})})})})},addScreen:function(e){api.stop||(screenshot.retries++,chrome.tabs.sendMessage(screenshot.thisTabId,$.extend({cropData:screenshot.cropData,type:"takeCapture",start:!0,scroll:screenshot.scroll,showScrollBar:screenshot.showScrollBar,processFixedElements:screenshot.processFixedElements},e),screenshot.ans))},ans:function(e){if(!api.stop){if(!e&&chrome.runtime.lastError){if(screenshot.retries>1&&screenshot.scroll)return void api.callPopup({type:"message",message:"Sorry, we can not take a full screenshot of this webpage. This might be because it is not fully loaded. Please report this issue."});if(!(screenshot.retries>1))return void codeinjector.executeOnTab(screenshot.thisTabId,screenshot.thisTab,!0,screenshot.addScreen);e={left:0,top:0,finish:!0}}null==e.top&&(e.top=0,e.left=0),e&&e.description&&(screenshot.description=e.description);screenshot.cropData&&(screenshot.cropData.x1,screenshot.cropData.x1);var t=function(t){chrome.runtime.lastError&&console.error(chrome.runtime.lastError),api.stop||((e.top||0==parseInt(e.top))&&screenshot.screens.push({left:parseInt(e.left),top:parseInt(e.top),data:t}),e.finish?(screenshot.screenShotParams=e,screenshot.createScreenShot()):screenshot.addScreen({start:!1}))},s=localStorage.speed;setTimeout(function(){chrome.windows.update(screenshot.thisWindowId,{focused:!0},function(){chrome.tabs.update(screenshot.thisTabId,{active:!0},function(){chrome.runtime.lastError&&console.error(chrome.runtime.lastError),chrome.tabs.captureVisibleTab(null,{format:"png"},t)})})},s)}},createScreenShot:function(){var e=screenshot.screenShotParams;chrome.tabs.sendMessage(screenshot.thisTabId,{type:"finish"});var t,s,r=[];function o(e){return e.replace(/%U/gi,screenshot.url).replace(/%D/gi,new Date)}t=o(localStorage.txtHeader),s=o(localStorage.txtFotter),screenshot.canvas=document.createElement("canvas"),(screenshot.runCallback||screenshot.disableHeaderAndFooter)&&(t="",s=""),screenshot.url||(url=e.url);var n=0,a=!0;loadImage=function(o){if(!api.stop){ctx=screenshot.canvas.getContext("2d"),ctx.imageSmoothingEnabled=!1,ctx.webkitImageSmoothingEnabled=!1,r[o]=$("<img tag="+o+"/>"),r[o].load(function(){var o;o=parseInt($(this).attr("tag"));var c=window.devicePixelRatio;a&&(screenshot.canvas.width=Math.ceil((e.width||r[o][0].width)/c),screenshot.canvas.height=Math.ceil((e.height||r[o][0].height)/c),a=!1,t&&(screenshot.canvas.height+=20,n=20),s&&(screenshot.canvas.height+=20)),o=parseInt($(this).attr("tag"));var l=Math.ceil(screenshot.screens[o].top/c)+n;if(ctx.imageSmoothingEnabled=!1,ctx.webkitImageSmoothingEnabled=!1,ctx.drawImage(r[o][0],Math.ceil(screenshot.screens[o].left/c),l,Math.ceil(r[o][0].width/c),Math.ceil(r[o][0].height/c)),screenshot.screens[o].data=null,r[o][0].src="",r[o].off("load"),r[o][0]=null,r[o].remove(),r[o]=null,o===screenshot.screens.length-1)return ctx.font="arial 20px",s&&(ctx.textBaseline="bottom",ctx.fillText(s,10,screenshot.canvas.height,screenshot.canvas.width-20)),t&&(ctx.textBaseline="up",ctx.fillText(t,10,10,screenshot.canvas.width-20)),screenshot.resizeBack&&chrome.windows.getCurrent(function(e){chrome.windows.update(e.id,{width:screenshot.currentWidth,height:screenshot.currentHeight})}),ctx=null,void(screenshot.runCallback?(screenshot.callback(screenshot.canvas.toDataURL()),screenshot.callback=null,screenshot.keepIt||(delete screenshot.callback,screenshot.canvas.width=screenshot.canvas.height=1,screenshot.callback=null,screenshot.canvas.remove(),screenshot.canvas=null,delete screenshot.canvas)):(chrome.tabs.create({url:chrome.extension.getURL("editor.html")+"#last"}),delete screenshot.callback,editorDocument=null,editor=null,imgFix=null));api.stop||loadImage(++o)});try{r[o].attr("src",screenshot.screens[o].data),delete screenshot.screens[o].data}catch(e){}}},api.stop||loadImage(0)},sbPause:function(){localStorage.sb_enable="no",executeCodeOnAllTabs("sb_pause()")},sbStart:function(){localStorage.sb_enable="yes",executeCodeOnAllTabs("sb_start()")},sbPauseOnUrl:function(e){disabledURLs=localStorage.sb_disableURLs||"{}",disabledURLs=JSON.parse(disabledURLs),disabledURLs[e]="disabled",localStorage.sb_disableURLs=JSON.stringify(disabledURLs),executeCodeOnAllTabs("var fdsrkldsf=null;")},sbStartOnUrl:function(e){disabledURLs=localStorage.sb_disableURLs||"{}",disabledURLs=JSON.parse(disabledURLs),delete disabledURLs[e],localStorage.sb_disableURLs=JSON.stringify(disabledURLs),executeCodeOnAllTabs("var fdsrkldsf=null;")}};