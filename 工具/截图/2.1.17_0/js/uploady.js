var uploady=function(e,n){var r,t,o,s,i="Screenshots";return{init:u,upload:c(function(r){var t=new FormData;return t.append("file",r.blob,r.filename),t.append("share_link_enabled",!0),t.append("folder_id",o),e.ajax({type:"POST",url:n.uploadUrl+"?access_token="+h(),processData:!1,contentType:!1,dataType:"json",data:t}).then(A,j)}),isConnected:a,isTemporary:l,getExpirationDate:p,connectUser:c(function(){return y().then(T).then(function(){return r?_():e.Deferred().resolve().promise()}).then(function(){return o?(r=t.links.root_folder,e.ajax({type:"PUT",url:n.apiUrl+"folders",headers:{Authorization:"Bearer "+h()},dataType:"json",data:{id:o,parent_id:r}}).then(A,j)):U();var r})}),disconnectUser:k,getUser:function(){return t},getFolderUrl:function(){return n.myfilesUrl+o}};function c(e){return function(){return u().then(e.bind.apply(e,[null].concat(Array.prototype.slice.call(arguments))))}}function u(){return g(),s?a()&&s.isAccessTokenExpired()?y().then(u):f()?l()&&d()?x().then(u):o?e.Deferred().resolve().promise():U().then(u):e.post(n.apiUrl+"users/remote",{access_token:n.clientAccessToken}).then(A,j).then(function(e){return t=e.users.pop(),D(e),v(),e}).then(u):m().then(u)}function a(){return s&&!!s.getAccessToken()}function f(){return s&&!!s.getAccessToken()||!!r}function l(){return f()&&!a()}function p(){return r&&r.expiration_date}function d(){return p()<Date.now()}function h(){if(s&&s.getAccessToken())return s.getAccessToken();if(r)return r.access_token;throw"User is not authorized"}function _(){return d()?x().then(_):(t=r.access_token,e.post(n.apiUrl+"users/merge",{access_token:h(),merge_with_access_token:t}).then(A,j));var t}function k(){s&&s.clear(),localStorage.uploady="",g()}function m(){var r=e.Deferred();return function(){var n=e.Deferred();return premissions.checkPermissions({origins:["http://*.uploady.com/*","https://*.uploady.com/*"]},function(){n.resolve()}),n.promise()}().then(function(){s=new OAuth2("uploady",{client_id:n.clientId,api_scope:"profile create.folder create.file share.file user.merge update.folder"},function(){s=this,r.resolve()})}),r.promise()}function y(){var n=e.Deferred();return m().then(function(){s.authorize(function(e){e?n.reject():n.resolve()})}),n.promise()}function g(){var e=JSON.parse(localStorage.uploady||null)||{};return t=e.user,r=e.token,o=e.folderId,!!e}function v(){localStorage.setItem("uploady",JSON.stringify({user:t,token:r,folderId:o,isConnected:a()}))}function D(e){r={access_token:e.access_token,expires_in:e.expires_in,refresh_token:e.refresh_token,expiration_date:Date.now()+1e3*e.expires_in}}function T(){return e.get(n.apiUrl+"users",{access_token:h()}).then(A,j).then(function(e){return t=e.users.pop(),v(),e})}function U(){return e.post(n.apiUrl+"folders",{access_token:h(),name:i}).then(A,j).then(function(e){return o=e.folders.pop().id,v(),e})}function x(){return e.post(n.tokenURL,{client_id:n.clientId,refresh_token:r.refresh_token,grant_type:"refresh_token"}).then(A,j).then(function(e){return e.refresh_token=e.refresh_token||r.refresh_token,D(e),v(),e},k)}function A(n){return n.error?(alert("Invalid request \n"+n.error+":"+n.error_code+"\n"+n.error_description),e.Deferred().reject(n).promise()):n}function j(n){return alert("Request failed, if this is error happened more than once, please go to `extension settings` -> `share settings` and click `Disconnect my current user`. \n\n Details:\n"+n.status+":"+n.statusText+"\n"+n.responseText),e.Deferred().reject(n).promise()}}(jQuery,settings.uploady);