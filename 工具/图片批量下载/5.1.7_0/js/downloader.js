var downloader=function(){function e(e){var n=e.bigUrl||e.originalUrl,a="jpg",i=e.alt,o=n.lastIndexOf("/"),s=n.substr(o+1,n.length);if((o=s.lastIndexOf("?"))>=0&&(s=s.substr(0,o)),(o=s.lastIndexOf("."))>=0&&(a=s.substr(o+1,s.length),s=s.substr(0,o)),s=s+"."+(a=("jpeg"==e.ext?"jpg":e.ext)||a),i&&(s=i+"."+a),r.needRename&&r.renameRule){var l;l=s.substring(0,s.lastIndexOf(".")||s.length),s=utils.replaceVarible({text:r.renameRule,index:e.selected?e.selectIndex:e.showIndex,ext:a,name:l})}s.lastIndexOf(".")<0&&(s+=".jpg");var u=s;try{u=decodeURIComponent(s)}catch(e){}var d=u.replace(/[-/~|\\-\\:*?"'<>=%$@#+;,!\^]/g,"_").replace(/\.+$/g,"").split(".");d[0]=t(d[0].substr(0,100));var c=d=d.join(".");return"FIXED"==r.dirType?r.fixedDir&&(c=t(r.fixedDir)+"/"+d):e.docTitle&&(c=t(e.docTitle)+"/"+d),c}function t(e){return e.replace(/[-~|\\-\\/:*?"'<>=%$@#+;,!\^]/g,"_").replace(/\.+$/g,"").substr(0,100)}function n(t){if(t){var n=t.bigUrl,a=t.blobUrl,i=e(t),s=a||n;r.autoConvertWebp&&t.jpgPngDataUrl&&(s=t.jpgPngDataUrl),"VIDEO"==t.type&&(s=t.originalUrl),chrome.downloads.download({url:s,filename:i,saveAs:!1,conflictAction:"uniquify"},function(r){if(r&&(o[r]=t),!r&&chrome.runtime.lastError&&chrome.runtime.lastError.message.match("Invalid filename")){var a=t.ref;a&&(a=(a=a.replace(/.*?:\/\//,"")).replace(/\?.*/,"")),a.match("/$")||(a+="/");var i=e(n);chrome.downloads.download({url:n,filename:a+i,saveAs:!1,conflictAction:"uniquify"},function(e){})}})}}chrome.downloads.onChanged.addListener(function(e){if(e.state&&r.limitConcurrent&&e.state.current.match("complete|interrupted")){var t=o[e.id];if(t&&(a(e.state.current,t),s<i.length)){var l=i[s];"started"!=downloader.status&&"resumed"!=downloader.status||(s++,n(l))}}});var r,a,i=[],o=[],s=0;return{status:"not-inited",init:function(e,t){r=e,a=t,s=0},download:function(e){i=e,s=0,i=e;for(var t=r.limitConcurrent||10,a=0;a<t&&a<i.length;a++)s++,n(i[a]);this.status="started"},downloadSingle:function(e){n(e)},stop:function(){this.status="stoped"},pause:function(){this.status="paused"},resume:function(){this.status="resumed";for(var e=0;e<r.limitConcurrent&&s<i.length;e++)n(i[s++])}}}();