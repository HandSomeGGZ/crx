var _config,gApp;navigator.userAgent.match("QQBrowser")&&document.body.classList.add("qq-browser");var newImgList=[],tabId=location.href.match(/tabId=(\d+)/);tabId=tabId?parseInt(tabId[1]):"";var tabTitle="",startedTabIds=[];function main(t){function e(t){chrome.runtime.sendMessage({cmd:"GET_ADVANCEC_IMGS",tabId:t.id},function(e){e.map(function(t){return t.src});chrome.tabs.sendMessage(t.id,{cmd:"GET_IMAGE_FROM_BG3",tabInfo:t})})}chrome.runtime.onMessage.addListener(function(t,e,n){return tabId&&t.tabId!=tabId||("ADD_IMG"==t.cmd?i.addItem(t.item):"ADD_IMG_LIST"==t.cmd?t.list.forEach(function(t,i){new ParsedPItem({src:t},i,e.tab,function(t){gApp.addItem(t)})}):"ADD_VIDEO"==t.cmd&&i.addItem(t.item)),!0}),window.addEventListener("resize",function(){i.picListWidth=250*parseInt(window.innerWidth/250)});var i=gApp=new Vue({el:"#app",data:{imgList:[],maxWidth:t.rememberFilter&&t.widthRange?t.widthRange[1]:0,maxHeight:t.rememberFilter&&t.heightRange?t.heightRange[1]:0,urlfilter:"",sortType:"default",showSort:!1,config:t,showOutputTextPanel:!1,downloader:downloader,viewModel:"normal",i18n:currentI18n,currentPage:1,pageSize:10*parseInt(window.innerWidth/250),selectionBoxStyling:{},startedTabs:[],selectedTabs:"",showSaveTips:!1,saveTipsDoNotShowAgain:JSON.parse(localStorage.saveTipsDoNotShowAgain||"false"),widthRange:t.rememberFilter&&t.widthRange||[0,0],heightRange:t.rememberFilter&&t.heightRange||[0,0],picListWidth:250*parseInt(window.innerWidth/250)},computed:{needRename:{get:function(){return t.needRename},set:function(e){t.needRename=e,appConfig.setConfig(t)}},renameRule:{get:function(){return t.renameRule},set:function(e){t.renameRule=e,appConfig.setConfig(t)}},unique:{get:function(){return t.unique},set:function(e){t.unique=e,appConfig.setConfig(t)}},concurrent:{get:function(){return t.limitConcurrent},set:function(e){t.limitConcurrent=e,appConfig.setConfig(t)}},rememberFilter:{get:function(){return t.rememberFilter},set:function(e){t.rememberFilter=e,appConfig.setConfig(t)}},outputTextFormat:{get:function(){return t.outputTextFormat},set:function(e){t.outputTextFormat=e,appConfig.setConfig(t)}},showImgList:function(){var t=this,e=[],i=this.urlfilter.replace("，",",").split(",").join(".*");this.imgList.forEach(function(n){n.originalUrl&&t.checkSize(n)&&(0==t.selectedTabs.length||t.selectedTabs.indexOf(n.tabId)>=0)&&n.originalUrl.match(i)&&(n.showIndex=e.length,e.push(n))}),this.config.unique&&(e=_.uniqBy(e,"bigUrl"));var n=this.sortType;return"default"==n?e.sort(function(t,e){return t.tabIndex!=e.tabIndex?t.tabIndex-e.tabIndex:t.index-e.index}):"site"==n||("bigFirst"==n?e.sort(function(t,e){return e.size-t.size}):"smallFirst"==n&&e.sort(function(t,e){return t.size-e.size})),e.forEach(function(t,e){t.showIndex=e}),e},currentPageImgs:function(){return this.showImgList.slice(this.pageSize*(this.currentPage-1),this.pageSize*this.currentPage)},selectedImgs:function(){var t=[];return this.showImgList.forEach(function(e){e.selected&&(e.selectIndex=t.length,t.push(e))}),t},downloadedImgs:function(){var t=[];return this.showImgList.forEach(function(e){"complete"==e.status&&t.push(e)}),t},interruptedImgs:function(){var t=[];return this.showImgList.forEach(function(e){"interrupted"==e.status&&t.push(e)}),t},outputText:function(){var t=this.config.outputTextFormat,e=[];return this.selectedImgs.forEach(function(i,n){var s=i.bigUrl,a=utils.replaceVarible({text:t,index:n,link:s});e.push(a)}),e.join("\n")},downloaderStatus:function(){return downloader.status}},mounted:function(){var i=this;if(tabId)chrome.tabs.get(tabId,function(t){tabTitle=t.title,document.title=tabTitle,e(t)});else{function n(){var t=JSON.parse(localStorage.imageTabIds||"[]");t.length>startedTabIds.length&&(t.slice(startedTabIds.length).forEach(function(t){chrome.tabs.get(t,function(t){utils.checkTabDownloadableByUrl(t.url)&&(e(t),t.shortTitle=t.title.length<40?t.title:t.title.substr(0,20)+"..."+t.title.substr(-20),i.startedTabs.push(t))})}),startedTabIds=t)}n(),setInterval(n,1e3)}i=this;if(setInterval(function(){newImgList.length>0&&(i.imgList=i.imgList.concat(newImgList),newImgList=[])},1e3),t.dragSelect){var s,a;document.body.addEventListener("dragstart",function(t){t.preventDefault()});var o,r,h,g;function u(){o=0,r=0,h=0,g=0,s=null,a=null,i.selectionBoxStyling={}}function d(t){Math.abs(t.pageX-s.x)<10&&Math.abs(t.pageY-s.y)<10||(a={x:t.pageX,y:t.pageY},o=Math.min(s.y,a.y),r=Math.min(s.x,a.x),h=Math.abs(a.x-s.x),g=Math.abs(a.y-s.y),i.selectionBoxStyling={top:o+"px",left:r+"px",width:h+"px",height:g+"px"})}function c(){!1,window.removeEventListener("mousemove",d),window.removeEventListener("mouseup",c),Math.abs(event.pageX-s.x)<10&&Math.abs(event.pageY-s.y)<10||(document.querySelectorAll(".img-item").forEach(function(t){if(utils.offset(t,"left")+t.offsetWidth>r&&utils.offset(t,"top")+t.offsetHeight>o&&utils.offset(t,"left")<r+h&&utils.offset(t,"top")<o+g){var e=i.showImgList[(i.currentPage-1)*i.pageSize+parseInt(t.dataset.index)];e.selected=!e.selected}}),u())}u(),document.getElementById("main-content").addEventListener("mousedown",function(t){2!==t.button&&(!0,s={x:t.pageX,y:t.pageY},window.addEventListener("mousemove",d),window.addEventListener("mouseup",c))})}},watch:{urlfilter:function(){this.currentPage=1},unique:function(){this.currentPage=1},saveTipsDoNotShowAgain:function(t){localStorage.saveTipsDoNotShowAgain=t}},methods:{addItem:function(t){("IMG"!=t.type||t.width&&t.height)&&(t.selected=!0,t.size=t.width*t.height,t.index=void 0!==t.index?t.index:this.imgList.length,t.status="added",t.w=t.width,t.h=t.height,t.src=t.bigUrl,t.id=t.tabIndex+"_"+t.index,newImgList.push(t),t.width>i.maxWidth&&(i.maxWidth=t.width,i.rememberFilter&&i.config.widthRange?i.maxWidth>i.config.widthRange[1]&&(i.widthRange[1]=i.config.widthRange[1]):i.widthRange[1]=i.maxWidth),t.height>i.maxHeight&&(i.maxHeight=t.height,i.rememberFilter&&i.config.heightRange?i.maxHeight>i.config.heightRange[1]&&(i.heightRange[1]=i.config.heightRange[1]):i.heightRange[1]=i.maxHeight))},checkSize:function(t){return(!this.widthRange||t.width>=this.widthRange[0]&&t.width<=this.widthRange[1])&&(!this.heightRange||t.height>=this.heightRange[0]&&t.height<=this.heightRange[1])},itemClick:function(t){var e=this.imgList.indexOf(t);t.selected=!t.selected,this.imgList.splice(e,1,t)},resetFilter:function(){this.config.widthRange=null,this.config.heightRange=null,appConfig.setConfig({widthRange:null,heightRange:null}),this.currentPage=1,this.widthRange=[0,this.maxWidth],this.heightRange=[0,this.maxHeight],this.urlfilter="",this.selectedTabs=""},resetWhRange:function(){this.config.widthRange=null,this.config.heightRange=null,appConfig.setConfig({widthRange:null,heightRange:null}),this.currentPage=1,this.widthRange=[0,this.maxWidth],this.heightRange=[0,this.maxHeight]},toggle:function(){this.showImgList.forEach(function(t){t.selected=!t.selected})},selectAll:function(){this.showImgList.forEach(function(t){t.selected=!0})},sortBy:function(t){this.sortType=t,this.showSort=!1},changeView:function(){this.viewModel="normal"==this.viewModel?"spread":"normal"},getDir:function(){return"FIXED"==t.dirType?t.fixedDir:tabTitle},realDowload:function(){this.imgList.forEach(function(t,e){t.status="added"}),downloader.init(t,function(t,e){e.status=t,this.imgList.splice(this.imgList.indexOf(e),1,e),this.downloadedImgs.length+this.interruptedImgs.length==this.selectedImgs.length&&(downloader.status="complete")}.bind(this)),downloader.download(this.selectedImgs)},download:function(){this.saveTipsDoNotShowAgain?this.realDowload():this.showSaveTips=!0},viewBig:function(t){var e=document.querySelectorAll(".pswp")[0],i={index:(this.currentPage-1)*this.pageSize+t};new PhotoSwipe(e,PhotoSwipeUI_Default,this.showImgList,i).init()},openLink:function(t){chrome.tabs.create({url:t})},share:function(t){var e={url:t.bigUrl,title:"#Fatkun批量下载图片#",pic:t.bigUrl},i=[];for(var n in e)i.push(n+"="+encodeURIComponent(e[n]||""));window.open("http://service.weibo.com/share/share.php?"+i.join("&"),"_blank","width=615,height=405")},downloadSingle:function(e){downloader.init(t,function(t,e){e.status=t,this.imgList.splice(this.imgList.indexOf(e),1,e)}.bind(this)),downloader.downloadSingle(e)},pauseDownload:function(){"paused"==downloader.status?downloader.resume():downloader.pause()},exportLinks:function(){this.showOutputTextPanel=!0},closeLinksPanel:function(){this.showOutputTextPanel=!1},resetOutputTextFormat:function(){this.outputTextFormat=appConfig.getDefaultConfig().outputTextFormat},changePage:function(t){this.currentPage=t},saveTipsClose:function(){this.showSaveTips=!1},saveTipsSave:function(){this.showSaveTips=!1,this.realDowload()},saveWidthRange:function(t){appConfig.setConfig({widthRange:t}),this.currentPage=1},saveHeightRange:function(t){appConfig.setConfig({heightRange:t}),this.currentPage=1}}})}appConfig.init(function(t){_config=t,bigImgParser.init(function(){main(t)})}),setTimeout(function(){tj.send("page",{p:"output"})},2e3),document.body.addEventListener("click",function(t){var e=t.target.closest("[data-tj-btn]");e&&tj.send("btn",{p:"output",id:e.dataset.tjBtn})},!0);