var removeClip,x1,x2,y1,y2,rx1,rx2,ry1,ry2,showCropOverFlow,cropperLoaded=!1,cropperLoadTime=Date.now(),cropperOpen=!1;function loadCropper(){if(!cropperLoaded){cropperLoaded=!0,removeClip=function(){window.crop&&window.crop.icons&&Date.now()-cropperLoadTime>1e3&&(e(),cropperOpen=!1)},showCropOverFlow=function(){e();window.crop.y2-window.crop.y1<60&&(window.crop.y2=window.crop.y1+60),window.crop.x2-window.crop.x1<60&&(window.crop.x2=window.crop.x1+60),window.crop.x1<0&&(window.crop.x1=0),window.crop.y1<0&&(window.crop.y1=0),window.crop.y2<0&&(window.crop.y2=0),window.crop.x2>$(document).width()-5&&(window.crop.x2=$(document).width()-5),window.crop.y2>$(document).height()-5&&(window.crop.y2=$(document).height()-5),x1=window.crop.x1,x2=window.crop.x2,y1=window.crop.y1,y2=window.crop.y2,x1<x2?(rx1=x1,rx2=x2):(rx1=x2,rx2=x1),y1<y2?(ry1=y1,ry2=y2):(ry1=y2,ry2=y1),x1=rx1,x2=rx2,y1=ry1,y2=ry2,$("<div id=crop_helper><div id=crop_center></div><div id=crop_helper_bottom></div><div id=crop_helper_left></div><div id=crop_helper_top></div><div id=crop_helper_right></div></div>").appendTo(document.body),$("#crop_helper").css({}),window.crop.move&&$("#crop_helper").css("cursor",window.crop.move+"-resize"),$("#crop_helper *").css({"background-color":"#000",opacity:"0.8",position:"absolute","z-index":1999999999}),$("#crop_helper_left").css({"background-color":"#000",left:0,top:0,width:x1,height:$(document).height()}),$("#crop_helper_top").css({"background-color":"#000",left:x1,top:0,width:x2-x1,height:y1}),$("#crop_helper_bottom").css({"background-color":"#000",left:x1,top:y2,width:x2-x1,height:$(document).height()-y2}),$("#crop_helper_right").css({"background-color":"#000",left:x2,top:0,width:$(document).width()-x2,height:$(document).height()}),$("#crop_center").css({"background-color":"",cursor:"move",left:x1,top:y1,width:x2-x1,height:y2-y1}),$("#crop_center").data("cord",{x1:x1,x2:x2,y1:y1,y2:y2});var o=$("<div class=crop_handle></div>").css({width:8,height:8,"background-color":"black",position:"absolute","z-index":2e9}),r={ne:{x:x2-8,y:y1},nw:{x:x1,y:y1},se:{x:x2-8,y:y2-8},sw:{x:x1,y:y2-8},n:{x:x1+(x2-x1)/2,y:y1},s:{x:x1+(x2-x1)/2,y:y2-8},w:{y:y1+(y2-y1)/2,x:x1},e:{y:y1+(y2-y1)/2,x:x2-8}},n=window.crop.icons;n.css({"z-index":2000000002,position:"absolute"}).appendTo("#crop_helper");var c={left:($(window).width()-n.width())/2,top:0,position:"fixed"};for(var p in n.css({left:c.left,top:c.top,position:c.position}),r)o.clone().data("cord",p).css({left:r[p].x,top:r[p].y,cursor:p+"-resize"}).appendTo($("#crop_helper"))},$(document).on("keyup",function(o){removeClip()}),$(document).on("click","div[id*=crop_helper_]",function(){removeClip()});var o=function(o){o.pageY>$(window).scrollTop()+$(window).height()-30&&$(window).scrollTop($(window).scrollTop()+30),o.pageY<$(window).scrollTop()+30&&$(window).scrollTop($(window).scrollTop()-30)};$(document).on("mousedown","#crop_center",function(e){$(document).on("mousemove.cropcenter",function(e){return window.crop.startX&&(window.crop.x1+=e.pageX-window.crop.startX,window.crop.x2+=e.pageX-window.crop.startX,window.crop.y1+=e.pageY-window.crop.startY,window.crop.y2+=e.pageY-window.crop.startY),showCropOverFlow(),window.crop.startX=e.pageX,window.crop.startY=e.pageY,o(e),e.stopPropagation(),!1}),$(document).on("mouseup.cropcenter",function(o){return window.crop.startX=null,window.crop.startY=null,$(document).off(".cropcenter"),o.stopPropagation(),!1})}),$(document).on("mousedown",".crop_handle",function(e){return o(e),$(document).on("mousemove.handle",{cord:$(e.target).data("cord")},function(e){e.screenX,e.screenY;var r=e.data.cord;return"se"==r&&(window.crop.x2=e.pageX,window.crop.y2=e.pageY),"sw"==r&&(window.crop.x1=e.pageX,window.crop.y2=e.pageY),"nw"==r&&(window.crop.x1=e.pageX,window.crop.y1=e.pageY),"ne"==r&&(window.crop.x2=e.pageX,window.crop.y1=e.pageY),"w"==r&&(window.crop.x1=e.pageX),"e"==r&&(window.crop.x2=e.pageX),"n"==r&&(window.crop.y1=e.pageY),"s"==r&&(window.crop.y2=e.pageY),window.crop.move=r,o(e),showCropOverFlow(),e.stopPropagation(),!1}),$(document).on("mouseup.handle",function(o){return window.crop.move=null,showCropOverFlow(),$(document).off(".handle"),o.stopPropagation(),!1}),e.stopPropagation(),!1})}function e(){window.crop.icons.detach(),$("#crop_helper").add(".crop_handle").remove(),$(document).off(".removeCrop")}}function load_cropper_without_selection(o){if(loadCropper(),!cropperOpen){removeClip(),cropperOpen=!0,cropperLoadTime=Date.now(),window.crop=o||{x1:$(window).scrollLeft()+300,x2:$(window).scrollLeft()+600,y1:$(window).scrollTop()+300,y2:$(window).scrollTop()+600};var e=$('<div><button class="open msg" style="margin:0;color:black;background-color:white;cursor:pointer;font-size:12px;border: 1px solid #999; border-radius: 0px;padding: 3px 9px;" tag=open></button><button class="save msg" style="margin:0;color:black;background-color:white;cursor:pointer;font-size:12px;border: 1px solid #999; border-radius: 0px;padding: 3px 9px;" tag=save></button><button class="share msg" style="margin:0;color:black;background-color:white;cursor:pointer;font-size:12px;border: 1px solid #999; border-radius: 0px;padding: 3px 9px;" tag=share></button><div class="realToolbar" style="display: none"></div></div>');jQuery(".msg",e).each(function(){jQuery(this).html(chrome.i18n.getMessage(jQuery(this).attr("tag")))});var r=$(".realToolbar",e);window.crop.icons=e;var n=defaultPlugins.slice();n=$.grep(n,function(o){return"googledrive"!=o.key}),$("button.open",e).on("click",function(){removeClip(),chrome.runtime.sendMessage({data:"captureAll",showScrollBar:!0,disableHeaderAndFooter:!0,processFixedElements:!1,cropData:{x1:x1,x2:x2,y1:y1,y2:y2,scrollTop:$(window).scrollTop(),scrollLeft:$(window).scrollLeft()}})}),$("button.save",e).on("click",function(){$("[plugin-key=save]").trigger($.Event({type:"click"}))}),$("button.share",e).on("click",function(){$("[plugin-key=uploady]").trigger($.Event({type:"click"}))});new Toolbar({plugins:n,element:r,namespace:"imageToolbar",button_size:"20",lines:2,page_title:$("title").html()||"no title",page_description:"no description",page_url:location.href,icon_base:chrome.extension?chrome.extension.getURL("/images/"):"../images/",whiteIcons:!0,position:"static",type:"image",zIndex:11e3,request:function(o){removeClip(),chrome.runtime.sendMessage({data:"captureAll",runCallback:!0,keepIt:!0,showScrollBar:!0,disableHeaderAndFooter:!0,processFixedElements:!1,cropData:{x1:x1,x2:x2,y1:y1,y2:y2,scrollTop:$(window).scrollTop(),scrollLeft:$(window).scrollLeft()}},function(e){o(e)})}});showCropOverFlow()}}